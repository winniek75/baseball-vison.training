# 要件定義書 — WISE Vision Training App

**プロジェクト名：** WISE Vision Training App  
**バージョン：** 1.0（PHASE 1 MVP）  
**作成日：** 2026年2月  
**ステータス：** 開発中（Vercel デプロイ済み）

---

## 1. プロジェクト背景・目的

### 1.1 背景
WISE Baseball Academy Online は、野球指導のオンラインサービスを展開している。
既存サービス（月額コーチング）への付加価値として、選手が自宅でも毎日取り組める
ビジョントレーニングアプリを開発する。

### 1.2 科学的根拠
- 人間の外界情報収集の80〜87%を視覚が担う
- 順天堂大学研究（2023）：視覚トレーニングは実打撃と同等以上の視機能向上効果を持つ
- スポーツビジョン黄金期（7〜10歳）に習慣化することで長期的なキャリアに影響

### 1.3 目的
1. 野球選手の視機能（KVA動体視力・眼と手の協応・瞬間視など）を科学的に向上させる
2. 「楽しい・続けられる」ゲーム設計で習慣化を促進する
3. WISEアカデミーの月額サービスの付加価値として差別化を図る
4. コーチが選手の視機能データを把握し、より根拠ある個別指導を実現する

---

## 2. ターゲットユーザー

| ユーザー種別 | 対象 | 主な利用シーン |
|------------|------|--------------|
| 選手（小学生） | 小1〜小6 | 自主練前ウォームアップ・自宅でのトレーニング |
| 選手（中学生） | 中1〜中3 | 練習後クールダウン・宿題感覚での継続利用 |
| 選手（高校生） | 高1〜高3 | 試合前アクティベーション・本格トレーニング |
| コーチ | WISEコーチ陣 | 選手の視機能弱点把握・指導補助（PHASE 3〜） |
| 保護者 | 選手の保護者 | 子どもの成長確認（ダッシュボード閲覧） |

---

## 3. 対応環境

| 環境 | 詳細 |
|------|------|
| iPad | 9.7インチ〜13インチ、iPadOS最新 |
| タッチパネルモニター | 21〜42インチ、Windows 10/11 |
| PC（閲覧） | Chrome/Safari/Edge 最新版（ダッシュボード・保護者向け） |
| スマートフォン | 補助対応（ゲームはiPad推奨） |

---

## 4. 機能要件

### 4.1 認証・プロフィール

#### FR-001 新規登録
- メールアドレス＋パスワード（6文字以上）で登録
- 2ステップ登録（STEP1：アカウント情報 / STEP2：プロフィール情報）
- プロフィール項目：表示名（必須）・学年（必須）・守備位置・チーム名
- 登録完了後、自動的にダッシュボードへ遷移

#### FR-002 ログイン
- メールアドレス＋パスワードでログイン
- エラー時は日本語メッセージを表示

#### FR-003 ログアウト
- ヘッダーのボタンからログアウト
- ログアウト後はトップページへ遷移

#### FR-004 ルート保護
- 未認証ユーザーが `/dashboard`・`/games/**` にアクセスした場合、`/login` にリダイレクト
- Next.js Middleware で実装

---

### 4.2 ゲームモジュール共通仕様

#### FR-010 難易度選択
- 各ゲーム開始前に5段階の難易度を選択できる
- 難易度ごとに説明文を表示する

#### FR-011 カウントダウン
- ゲーム開始前に3・2・1のカウントダウンを表示する

#### FR-012 リアルタイムスコア表示
- プレイ中、スコア・コンボ数・残り時間（または進捗）をリアルタイム表示

#### FR-013 フィードバック表示
- タップ正誤に応じて「PERFECT / GREAT / OK / ミス」などのフィードバックを即時表示

#### FR-014 セッション結果画面
- ゲーム終了後に結果画面を表示（合計スコア・正確率・平均反応時間・ラウンド数）
- 「もう一度」「ダッシュボードへ」ボタンを設置

#### FR-015 結果の自動保存
- ゲーム終了後、Supabase の `game_sessions` テーブルに結果を自動保存

#### FR-016 反応時間計測精度
- `performance.now()` + `requestAnimationFrame` でミリ秒単位の計測
- `pointerdown` イベントで最速タッチ検出（iOS 300ms遅延を回避）

---

### 4.3 ゲーム① ピッチャーリアクション

#### FR-020 ボール投球アニメーション
- 画面奥（小さい）から手前（大きい）に向かってボールが飛んでくるアニメーション
- CSS perspective + requestAnimationFrame による滑らかな表示

#### FR-021 球種バリエーション
- 直球・カーブ・スライダー・チェンジアップ・フェイク（5種類）
- 球種により移動軌跡が変化（カーブ：左右移動、スライダー：斜め、など）

#### FR-022 ストライク判定
- 各球に「ストライク」or「ボール」の属性をランダムに付与
- ストライク球：タップ正解 / ボール球：タップしてはいけない

#### FR-023 フェイク球
- フェイク球は投球モーションを見せるが球が来ない
- フェイク球に反応しないと正解（難易度2以上で出現）

#### FR-024 難易度パラメータ

| 難易度 | 球速 | フェイク率 | 数字読みモード | ラウンド目標 |
|--------|------|------------|----------------|-------------|
| 1（入門） | 1800ms | 0% | なし | 20 |
| 2（初級） | 1500ms | 10% | なし | 25 |
| 3（中級） | 1200ms | 15% | なし | 30 |
| 4（上級） | 1000ms | 20% | あり | 35 |
| 5（超上級） | 800ms | 25% | あり | 40 |

#### FR-025 コンボシステム
- 3連続正解ごとにスコア倍率が上昇

#### FR-026 スコア計算
- PERFECT（反応 <300ms）：300pt × コンボ倍率
- GREAT（反応 <500ms）：200pt × コンボ倍率
- OK（500ms〜）：100pt × コンボ倍率
- フェイク見切り成功：50pt
- ミス・誤タップ：コンボリセット

---

### 4.4 ゲーム⑤ ボールナンバーハント

#### FR-030 ボール接近アニメーション
- ボールが遠方から手前に飛んでくるアニメーション（requestAnimationFrame）

#### FR-031 数字の一瞬表示
- ボールが最前面に来た瞬間だけ数字（1〜9 or 10〜99）を表示
- 設定時間経過後に数字が消える

#### FR-032 テンキー入力UI
- 数字消去後にテンキーパッドを表示
- 1桁モード：1〜9のボタンをタップで自動確定
- 2桁モード：2桁入力で自動確定（または「✓」ボタンで確定）

#### FR-033 難易度パラメータ

| 難易度 | 表示時間 | ラウンド数 | 桁数 |
|--------|----------|------------|------|
| 1（入門） | 1000ms | 15 | 1桁 |
| 2（初級） | 700ms | 18 | 1桁 |
| 3（中級） | 500ms | 20 | 1桁 |
| 4（上級） | 350ms | 22 | 2桁 |
| 5（超上級） | 200ms | 25 | 2桁 |

#### FR-034 スコア計算
- 正解基本点：100pt
- 反応時間ボーナス：`(1000 - min(反応時間ms, 1000)) / 10` pt を加算
- コンボボーナス：3連続ごとに倍率上昇

---

### 4.5 ダッシュボード

#### FR-040 統計表示
- 総セッション数・累計スコア・平均正確率・最速反応時間（ms）

#### FR-041 ゲームカード
- 各ゲームへのリンクカード
- ベストスコアを表示

#### FR-042 プレイ履歴
- 直近5件のセッション履歴（ゲーム種別・難易度・スコア・正確率・日付）

---

## 5. 非機能要件

### 5.1 パフォーマンス
- ゲームループは60fps（requestAnimationFrame）を維持
- 初回ページロード：3秒以内（Vercel Edge）
- タッチ遅延：`touch-action: manipulation` + `pointerdown` で最小化

### 5.2 セキュリティ
- Supabase Row Level Security（RLS）：ユーザーは自分のデータのみアクセス可
- Next.js Middleware によるルート保護
- 環境変数はすべて Vercel の Environment Variables で管理

### 5.3 アクセシビリティ
- タップターゲット最小サイズ：iPad = 44×44px、タッチパネルモニター = 60×60px
- `user-select: none`・`touch-action: none` でゲーム中の誤動作防止

### 5.4 目の健康・安全設計
- 1セッション最大3分、推奨1日10〜15分（将来的にアラート実装）
- 明るい環境での使用を推奨する案内をオンボーディングに設置予定

---

## 6. データベース設計

### `profiles` テーブル

| カラム | 型 | 制約 | 説明 |
|--------|----|------|------|
| id | UUID | PK | レコードID |
| user_id | UUID | FK（auth.users）・UNIQUE | Supabase Auth ユーザーID |
| display_name | TEXT | NOT NULL | 表示名 |
| position | TEXT | | 守備位置 |
| team_name | TEXT | | チーム名 |
| grade_level | INTEGER | 1〜12 | 学年（小1=1〜高3=12） |
| role | TEXT | player/coach/parent | ロール |
| avatar_url | TEXT | | アバター画像URL |
| created_at | TIMESTAMPTZ | | 作成日時 |
| updated_at | TIMESTAMPTZ | | 更新日時（自動更新） |

### `game_sessions` テーブル

| カラム | 型 | 制約 | 説明 |
|--------|----|------|------|
| id | UUID | PK | セッションID |
| user_id | UUID | FK（auth.users） | ユーザーID |
| game_type | TEXT | pitcher-reaction / ball-number-hunt | ゲーム種別 |
| score | INTEGER | | 合計スコア |
| accuracy | DECIMAL(5,2) | 0〜100 | 正確率（%） |
| avg_reaction_ms | DECIMAL(8,2) | | 平均反応時間（ms） |
| difficulty | INTEGER | 1〜5 | 難易度 |
| rounds | INTEGER | | ラウンド数 |
| duration_sec | INTEGER | | プレイ時間（秒） |
| created_at | TIMESTAMPTZ | | セッション日時 |

---

## 7. 画面一覧

| パス | 画面名 | 認証 | 説明 |
|------|--------|------|------|
| `/` | ランディングページ | 不要 | サービス紹介・登録/ログインへのCTA |
| `/signup` | 新規登録 | 不要 | 2ステップ登録フォーム |
| `/login` | ログイン | 不要 | メール＋パスワードログイン |
| `/dashboard` | ダッシュボード | 必要 | 統計・ゲーム選択・履歴 |
| `/games/pitcher-reaction` | ピッチャーリアクション | 必要 | 難易度選択→ゲーム→結果 |
| `/games/ball-number-hunt` | ボールナンバーハント | 必要 | 難易度選択→ゲーム→結果 |

---

## 8. 今後の課題・未実装事項

### PHASE 2 以降で実装予定

| 項目 | 優先度 | 説明 |
|------|--------|------|
| ゲーム②〜④⑥⑦ | 高 | 残り5モジュールの実装 |
| XP・レベルシステム | 高 | ゲーミフィケーション強化 |
| 視機能レーダーチャート | 高 | 6要素のビジョンプロフィール |
| デイリーミッション | 中 | 毎日更新のチャレンジ |
| チーム内ランキング | 中 | 週次リセットのスコア競争 |
| コーチ管理画面 | 中 | 選手データの一覧・分析 |
| 目の疲れ防止アラート | 中 | セッション時間超過の警告 |
| オフライン対応（PWA） | 低 | Service Worker + Manifest |
| LINE連携 | 低 | 既存サービスとの接続 |

### 既知の制約

- **KVA動体視力の完全再現不可：** 画面上の奥行き表現は本物のボールと異なる。補助的トレーニングとして位置づける
- **iOS Safari のタッチ遅延：** `touch-action: manipulation` で軽減しているが完全解消はできない
- **大型モニターでの体感：** 周辺視野モジュール（ゲーム④）はPHASE 2以降で実装予定

---

*WISE Baseball Academy Online — Vision Training App Requirements v1.0*
